image: golang:1.13

variables:
  GORELEASER_IMAGE: goreleaser/goreleaser:latest
  NANCY_VERSION: v0.0.36

stages:
  - test
  - lint
  - check
  - snapshot

go test:
  stage: test
  script:
    - go test -v
      -cover -covermode atomic

eclint:
  stage: lint
  script:
    - go build -o eclint cmd/eclint/main.go
    - ./eclint -exclude "testdata/**/*"

golangci-lint:
  stage: lint
  image: golangci/golangci-lint
  script:
    - golangci-lint run -v

nancy:
  stage: check
  script:
    - curl -sL -o nancy
      "https://github.com/sonatype-nexus-community/nancy/releases/download/${NANCY_VERSION}/nancy-linux.amd64-${NANCY_VERSION}"
    - chmod +x nancy
    - ./nancy go.sum

go-mod-outdated:
  stage: check
  script:
    - go get -u github.com/psampaz/go-mod-outdated
    - go list -u -m -json all | $GOPATH/bin/go-mod-outdated -update -direct -ci

goreleaser snapshot:
  stage: snapshot
  image: docker:stable
  services:
  - docker:dind
  script:
    - docker pull $GORELEASER_IMAGE
    - docker run
      --rm
      --privileged
      -v /var/run/docker.sock:/var/run/docker.sock
      -v $PWD:/go/src/gitlab.com/$CI_PROJECT_PATH
      -w /go/src/gitlab.com/$CI_PROJECT_PATH
      $GORELEASER_IMAGE
      --snapshot --skip-sign
